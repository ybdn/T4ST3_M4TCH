# render.yaml
#
# Blueprint pour déployer T4ST3_M4TCH sur Render
# Instructions :
# 1. Poussez ce fichier sur GitHub à la racine du repository
# 2. Sur Render, créez une "Blueprint Instance" et sélectionnez votre repository
# 3. Ajoutez les variables d'environnement sensibles dans le dashboard Render

services:
  # Service Backend (Django API)
  - type: web
    name: tastematch-backend
    runtime: docker
    plan: standard
    region: frankfurt
    
    # Configuration Docker
    dockerContext: .
    dockerfilePath: ./.docker/backend/Dockerfile
    dockerCommand: "python manage.py migrate && gunicorn tastematch_api.wsgi:application --host 0.0.0.0 --port $PORT"

    # Variables d'environnement
    envVars:
      - key: DATABASE_URL
        fromDatabase:
          name: tastematch-db
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      - key: DEBUG
        value: "False"
      - key: ALLOWED_HOSTS
        value: ".onrender.com,localhost,127.0.0.1"
      - key: CORS_ALLOWED_ORIGINS
        value: "https://tastematch-frontend.onrender.com,http://localhost:3000"
      # Variables sensibles à ajouter manuellement dans Render
      - key: SPOTIFY_CLIENT_ID
        sync: false
      - key: SPOTIFY_CLIENT_SECRET
        sync: false
      - key: TMDB_API_KEY
        sync: false
      - key: GOOGLE_BOOKS_API_KEY
        sync: false

  # Service Frontend (React App)
  - type: web
    name: tastematch-frontend
    runtime: static
    plan: free

    # Code source et build
    rootDir: ./frontend
    buildCommand: "npm ci && npm run build"
    staticPublishPath: "./dist"

    # Configuration SPA pour React Router
    headers:
      - path: /*
        name: Cache-Control
        value: public, max-age=3600
    
    routes:
      - type: rewrite
        source: /*
        destination: /index.html

    # Variables d'environnement pour le build
    envVars:
      - key: VITE_API_URL
        fromService:
          type: web
          name: tastematch-backend
          property: hostport

# Base de données PostgreSQL
databases:
  - name: tastematch-db
    plan: free
    region: frankfurt